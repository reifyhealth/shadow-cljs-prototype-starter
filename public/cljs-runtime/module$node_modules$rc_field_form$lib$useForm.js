shadow$provide.module$node_modules$rc_field_form$lib$useForm=function(global,require,module,exports){global=require("module$node_modules$$babel$runtime$helpers$interopRequireWildcard");module=require("module$node_modules$$babel$runtime$helpers$interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0});exports.default=exports.FormStore=void 0;var _slicedToArray2=module(require("module$node_modules$$babel$runtime$helpers$slicedToArray")),_objectSpread2=module(require("module$node_modules$$babel$runtime$helpers$objectSpread2")),
_objectWithoutProperties2=module(require("module$node_modules$$babel$runtime$helpers$objectWithoutProperties")),_toConsumableArray2=module(require("module$node_modules$$babel$runtime$helpers$toConsumableArray")),_classCallCheck2=module(require("module$node_modules$$babel$runtime$helpers$classCallCheck")),React=global(require("module$node_modules$react$index")),_warning=module(require("module$node_modules$rc_util$lib$warning")),_FieldContext=require("module$node_modules$rc_field_form$lib$FieldContext"),
_asyncUtil=require("module$node_modules$rc_field_form$lib$utils$asyncUtil"),_NameMap=module(require("module$node_modules$rc_field_form$lib$utils$NameMap")),_messages=require("module$node_modules$rc_field_form$lib$utils$messages"),_valueUtil=require("module$node_modules$rc_field_form$lib$utils$valueUtil"),FormStore=function FormStore(forceRootUpdate){var _this=this;(0,_classCallCheck2.default)(this,FormStore);this.formHooked=!1;this.subscribable=!0;this.store={};this.fieldEntities=[];this.initialValues=
{};this.callbacks={};this.lastValidatePromise=this.preserve=this.validateMessages=null;this.getForm=function(){return{getFieldValue:_this.getFieldValue,getFieldsValue:_this.getFieldsValue,getFieldError:_this.getFieldError,getFieldsError:_this.getFieldsError,isFieldsTouched:_this.isFieldsTouched,isFieldTouched:_this.isFieldTouched,isFieldValidating:_this.isFieldValidating,isFieldsValidating:_this.isFieldsValidating,resetFields:_this.resetFields,setFields:_this.setFields,setFieldsValue:_this.setFieldsValue,
validateFields:_this.validateFields,submit:_this.submit,getInternalHooks:_this.getInternalHooks}};this.getInternalHooks=function(key){if(key===_FieldContext.HOOK_MARK)return _this.formHooked=!0,{dispatch:_this.dispatch,initEntityValue:_this.initEntityValue,registerField:_this.registerField,useSubscribe:_this.useSubscribe,setInitialValues:_this.setInitialValues,setCallbacks:_this.setCallbacks,setValidateMessages:_this.setValidateMessages,getFields:_this.getFields,setPreserve:_this.setPreserve};(0,
_warning.default)(!1,"`getInternalHooks` is internal usage. Should not call directly.");return null};this.useSubscribe=function(subscribable){_this.subscribable=subscribable};this.setInitialValues=function(initialValues,init){_this.initialValues=initialValues||{};init&&(_this.store=(0,_valueUtil.setValues)({},initialValues,_this.store))};this.getInitialValue=function(namePath){return(0,_valueUtil.getValue)(_this.initialValues,namePath)};this.setCallbacks=function(callbacks){_this.callbacks=callbacks};
this.setValidateMessages=function(validateMessages){_this.validateMessages=validateMessages};this.setPreserve=function(preserve){_this.preserve=preserve};this.timeoutId=null;this.warningUnhooked=function(){_this.timeoutId||"undefined"===typeof window||(_this.timeoutId=window.setTimeout(function(){_this.timeoutId=null;_this.formHooked||(0,_warning.default)(!1,"Instance created by `useForm` is not connected to any Form element. Forget to pass `form` prop?")}))};this.getFieldEntities=function(){return 0<
arguments.length&&void 0!==arguments[0]&&arguments[0]?_this.fieldEntities.filter(function(field){return field.getNamePath().length}):_this.fieldEntities};this.getFieldsMap=function(){var pure=0<arguments.length&&void 0!==arguments[0]?arguments[0]:!1,cache=new _NameMap.default;_this.getFieldEntities(pure).forEach(function(field){var namePath=field.getNamePath();cache.set(namePath,field)});return cache};this.getFieldEntitiesForNamePathList=function(nameList){if(!nameList)return _this.getFieldEntities(!0);
var cache=_this.getFieldsMap(!0);return nameList.map(function(name){var namePath=(0,_valueUtil.getNamePath)(name);return cache.get(namePath)||{INVALIDATE_NAME_PATH:(0,_valueUtil.getNamePath)(name)}})};this.getFieldsValue=function(nameList,filterFunc){_this.warningUnhooked();if(!0===nameList&&!filterFunc)return _this.store;var filteredNameList=[];_this.getFieldEntitiesForNamePathList(Array.isArray(nameList)?nameList:null).forEach(function(entity){var _entity$isListField,namePath="INVALIDATE_NAME_PATH"in
entity?entity.INVALIDATE_NAME_PATH:entity.getNamePath();if(nameList||null===(_entity$isListField=entity.isListField)||void 0===_entity$isListField||!_entity$isListField.call(entity))filterFunc?(entity="getMeta"in entity?entity.getMeta():null,filterFunc(entity)&&filteredNameList.push(namePath)):filteredNameList.push(namePath)});return(0,_valueUtil.cloneByNamePathList)(_this.store,filteredNameList.map(_valueUtil.getNamePath))};this.getFieldValue=function(name){_this.warningUnhooked();name=(0,_valueUtil.getNamePath)(name);
return(0,_valueUtil.getValue)(_this.store,name)};this.getFieldsError=function(nameList){_this.warningUnhooked();return _this.getFieldEntitiesForNamePathList(nameList).map(function(entity,index){return!entity||"INVALIDATE_NAME_PATH"in entity?{name:(0,_valueUtil.getNamePath)(nameList[index]),errors:[]}:{name:entity.getNamePath(),errors:entity.getErrors()}})};this.getFieldError=function(name){_this.warningUnhooked();name=(0,_valueUtil.getNamePath)(name);return _this.getFieldsError([name])[0].errors};
this.isFieldsTouched=function(){_this.warningUnhooked();for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];_key=args[0];var arg1=args[1];_len=!1;if(0===args.length)var namePathList=null;else 1===args.length?Array.isArray(_key)?(namePathList=_key.map(_valueUtil.getNamePath),_len=!1):(namePathList=null,_len=_key):(namePathList=_key.map(_valueUtil.getNamePath),_len=arg1);args=_this.getFieldEntities(!0);var isFieldTouched=function(field){return field.isFieldTouched()};
if(!namePathList)return _len?args.every(isFieldTouched):args.some(isFieldTouched);var map=new _NameMap.default;namePathList.forEach(function(shortNamePath){map.set(shortNamePath,[])});args.forEach(function(field){var fieldNamePath=field.getNamePath();namePathList.forEach(function(shortNamePath){shortNamePath.every(function(nameUnit,i){return fieldNamePath[i]===nameUnit})&&map.update(shortNamePath,function(list){return[].concat((0,_toConsumableArray2.default)(list),[field])})})});args=function(entities){return entities.some(isFieldTouched)};
_key=map.map(function(_ref){return _ref.value});return _len?_key.every(args):_key.some(args)};this.isFieldTouched=function(name){_this.warningUnhooked();return _this.isFieldsTouched([name])};this.isFieldsValidating=function(nameList){_this.warningUnhooked();var fieldEntities=_this.getFieldEntities();if(!nameList)return fieldEntities.some(function(testField){return testField.isFieldValidating()});var namePathList=nameList.map(_valueUtil.getNamePath);return fieldEntities.some(function(testField){var fieldNamePath=
testField.getNamePath();return(0,_valueUtil.containsNamePath)(namePathList,fieldNamePath)&&testField.isFieldValidating()})};this.isFieldValidating=function(name){_this.warningUnhooked();return _this.isFieldsValidating([name])};this.resetWithFieldInitialValue=function(){var info=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},cache=new _NameMap.default,fieldEntities=_this.getFieldEntities(!0);fieldEntities.forEach(function(field){var initialValue=field.props.initialValue,namePath=field.getNamePath();
if(void 0!==initialValue){var records=cache.get(namePath)||new Set;records.add({entity:field,value:initialValue});cache.set(namePath,records)}});if(info.entities)var requiredFieldEntities=info.entities;else info.namePathList?(requiredFieldEntities=[],info.namePathList.forEach(function(namePath){if(namePath=cache.get(namePath)){var _requiredFieldEntitie;(_requiredFieldEntitie=requiredFieldEntities).push.apply(_requiredFieldEntitie,(0,_toConsumableArray2.default)((0,_toConsumableArray2.default)(namePath).map(function(r){return r.entity})))}})):
requiredFieldEntities=fieldEntities;(function(entities){entities.forEach(function(field){if(void 0!==field.props.initialValue)if(field=field.getNamePath(),void 0!==_this.getInitialValue(field))(0,_warning.default)(!1,"Form already set 'initialValues' with path '".concat(field.join("."),"'. Field can not overwrite it."));else{var records=cache.get(field);if(records&&1<records.size)(0,_warning.default)(!1,"Multiple Field with path '".concat(field.join("."),"' set 'initialValue'. Can not decide which one to pick."));
else if(records){var originValue=_this.getFieldValue(field);info.skipExist&&void 0!==originValue||(_this.store=(0,_valueUtil.setValue)(_this.store,field,(0,_toConsumableArray2.default)(records)[0].value))}}})})(requiredFieldEntities)};this.resetFields=function(nameList){_this.warningUnhooked();var prevStore=_this.store;nameList?(nameList=nameList.map(_valueUtil.getNamePath),nameList.forEach(function(namePath){var initialValue=_this.getInitialValue(namePath);_this.store=(0,_valueUtil.setValue)(_this.store,
namePath,initialValue)}),_this.resetWithFieldInitialValue({namePathList:nameList}),_this.notifyObservers(prevStore,nameList,{type:"reset"})):(_this.store=(0,_valueUtil.setValues)({},_this.initialValues),_this.resetWithFieldInitialValue(),_this.notifyObservers(prevStore,null,{type:"reset"}))};this.setFields=function(fields){_this.warningUnhooked();var prevStore=_this.store;fields.forEach(function(fieldData){var name=fieldData.name,data=(0,_objectWithoutProperties2.default)(fieldData,["name","errors"]);
name=(0,_valueUtil.getNamePath)(name);"value"in data&&(_this.store=(0,_valueUtil.setValue)(_this.store,name,data.value));_this.notifyObservers(prevStore,[name],{type:"setField",data:fieldData})})};this.getFields=function(){return _this.getFieldEntities(!0).map(function(field){var namePath=field.getNamePath();field=field.getMeta();namePath=(0,_objectSpread2.default)((0,_objectSpread2.default)({},field),{},{name:namePath,value:_this.getFieldValue(namePath)});Object.defineProperty(namePath,"originRCField",
{value:!0});return namePath})};this.initEntityValue=function(entity){var initialValue=entity.props.initialValue;void 0!==initialValue&&(entity=entity.getNamePath(),void 0===(0,_valueUtil.getValue)(_this.store,entity)&&(_this.store=(0,_valueUtil.setValue)(_this.store,entity,initialValue)))};this.registerField=function(entity){_this.fieldEntities.push(entity);if(void 0!==entity.props.initialValue){var prevStore=_this.store;_this.resetWithFieldInitialValue({entities:[entity],skipExist:!0});_this.notifyObservers(prevStore,
[entity.getNamePath()],{type:"valueUpdate",source:"internal"})}return function(isListField,preserve){var subNamePath=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[];_this.fieldEntities=_this.fieldEntities.filter(function(item){return item!==entity});if(!1===(void 0!==preserve?preserve:_this.preserve)&&(!isListField||1<subNamePath.length)){var namePath=entity.getNamePath();subNamePath=isListField?void 0:(0,_valueUtil.getValue)(_this.initialValues,namePath);namePath.length&&_this.getFieldValue(namePath)!==
subNamePath&&_this.fieldEntities.every(function(field){return!(0,_valueUtil.matchNamePath)(field.getNamePath(),namePath)})&&(_this.store=(0,_valueUtil.setValue)(_this.store,namePath,subNamePath,!0))}}};this.dispatch=function(action){switch(action.type){case "updateValue":_this.updateValue(action.namePath,action.value);break;case "validateField":_this.validateFields([action.namePath],{triggerName:action.triggerName})}};this.notifyObservers=function(prevStore,namePathList,info){if(_this.subscribable){var mergedInfo=
(0,_objectSpread2.default)((0,_objectSpread2.default)({},info),{},{store:_this.getFieldsValue(!0)});_this.getFieldEntities().forEach(function(_ref2){_ref2=_ref2.onStoreChange;_ref2(prevStore,namePathList,mergedInfo)})}else _this.forceRootUpdate()};this.updateValue=function(name,value){name=(0,_valueUtil.getNamePath)(name);var prevStore=_this.store;_this.store=(0,_valueUtil.setValue)(_this.store,name,value);_this.notifyObservers(prevStore,[name],{type:"valueUpdate",source:"internal"});value=_this.getDependencyChildrenFields(name);
value.length&&_this.validateFields(value);_this.notifyObservers(prevStore,value,{type:"dependenciesUpdate",relatedFields:[name].concat((0,_toConsumableArray2.default)(value))});if(prevStore=_this.callbacks.onValuesChange){var changedValues=(0,_valueUtil.cloneByNamePathList)(_this.store,[name]);prevStore(changedValues,_this.getFieldsValue())}_this.triggerOnFieldsChange([name].concat((0,_toConsumableArray2.default)(value)))};this.setFieldsValue=function(store){_this.warningUnhooked();var prevStore=
_this.store;store&&(_this.store=(0,_valueUtil.setValues)(_this.store,store));_this.notifyObservers(prevStore,null,{type:"valueUpdate",source:"external"})};this.getDependencyChildrenFields=function(rootNamePath){var children=new Set,childrenFields=[],dependencies2fields=new _NameMap.default;_this.getFieldEntities().forEach(function(field){(field.props.dependencies||[]).forEach(function(dependency){dependency=(0,_valueUtil.getNamePath)(dependency);dependencies2fields.update(dependency,function(){var fields=
0<arguments.length&&void 0!==arguments[0]?arguments[0]:new Set;fields.add(field);return fields})})});(function fillChildren(namePath){(dependencies2fields.get(namePath)||new Set).forEach(function(field){if(!children.has(field)){children.add(field);var fieldNamePath=field.getNamePath();field.isFieldDirty()&&fieldNamePath.length&&(childrenFields.push(fieldNamePath),fillChildren(fieldNamePath))}})})(rootNamePath);return childrenFields};this.triggerOnFieldsChange=function(namePathList,filedErrors){var onFieldsChange=
_this.callbacks.onFieldsChange;if(onFieldsChange){var fields=_this.getFields();if(filedErrors){var cache=new _NameMap.default;filedErrors.forEach(function(_ref3){cache.set(_ref3.name,_ref3.errors)});fields.forEach(function(field){field.errors=cache.get(field.name)||field.errors})}filedErrors=fields.filter(function(_ref4){_ref4=_ref4.name;return(0,_valueUtil.containsNamePath)(namePathList,_ref4)});onFieldsChange(filedErrors,fields)}};this.validateFields=function(nameList,options){_this.warningUnhooked();
var provideNameList=!!nameList,namePathList=provideNameList?nameList.map(_valueUtil.getNamePath):[],promiseList=[];_this.getFieldEntities(!0).forEach(function(field){provideNameList||namePathList.push(field.getNamePath());if((null===options||void 0===options?0:options.recursive)&&provideNameList){var namePath=field.getNamePath();namePath.every(function(nameUnit,i){return nameList[i]===nameUnit||void 0===nameList[i]})&&namePathList.push(namePath)}if(field.props.rules&&field.props.rules.length){var fieldNamePath=
field.getNamePath();if(!provideNameList||(0,_valueUtil.containsNamePath)(namePathList,fieldNamePath))field=field.validateRules((0,_objectSpread2.default)({validateMessages:(0,_objectSpread2.default)((0,_objectSpread2.default)({},_messages.defaultValidateMessages),_this.validateMessages)},options)),promiseList.push(field.then(function(){return{name:fieldNamePath,errors:[]}}).catch(function(errors){return Promise.reject({name:fieldNamePath,errors:errors})}))}});var summaryPromise=(0,_asyncUtil.allPromiseFinish)(promiseList);
_this.lastValidatePromise=summaryPromise;summaryPromise.catch(function(results){return results}).then(function(results){var resultNamePathList=results.map(function(_ref5){return _ref5.name});_this.notifyObservers(_this.store,resultNamePathList,{type:"validateFinish"});_this.triggerOnFieldsChange(resultNamePathList,results)});var returnPromise=summaryPromise.then(function(){return _this.lastValidatePromise===summaryPromise?Promise.resolve(_this.getFieldsValue(namePathList)):Promise.reject([])}).catch(function(results){results=
results.filter(function(result){return result&&result.errors.length});return Promise.reject({values:_this.getFieldsValue(namePathList),errorFields:results,outOfDate:_this.lastValidatePromise!==summaryPromise})});returnPromise.catch(function(e){return e});return returnPromise};this.submit=function(){_this.warningUnhooked();_this.validateFields().then(function(values){var onFinish=_this.callbacks.onFinish;if(onFinish)try{onFinish(values)}catch(err){console.error(err)}}).catch(function(e){var onFinishFailed=
_this.callbacks.onFinishFailed;onFinishFailed&&onFinishFailed(e)})};this.forceRootUpdate=forceRootUpdate};exports.FormStore=FormStore;exports.default=function(form){var formRef=React.useRef(),_React$useState=React.useState({}),forceUpdate=(0,_slicedToArray2.default)(_React$useState,2)[1];formRef.current||(form?formRef.current=form:(form=new FormStore(function(){forceUpdate({})}),formRef.current=form.getForm()));return[formRef.current]}}
//# sourceMappingURL=module$node_modules$rc_field_form$lib$useForm.js.map
